# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Java CI with Maven

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
 # Label of the runner job
  build-amuse:
    # You must use a Linux environment when using service containers or container jobs
    runs-on: ubuntu-latest

    # Service containers to run with `runner-job`
    services:
      # Label used to access the service container
      redis:
        # Docker Hub image
        image: redis
        # Set health checks to wait until redis has started
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          # Maps port 6379 on service container to the host
          - 6379:6379     
    steps:
    - name: Shutdown Ubuntu MySQL (SUDO)
      run: sudo service mysql stop # Shutdown the Default MySQL, "sudo" is necessary, please not remove it
    - name: Set up MariaDB
      uses: getong/mariadb-action@v1.1
      with:
        #host port: 3800 # Optional, default value is 3306. The port of host
        #container port: 3307 # Optional, default value is 3306. The port of container
        character set server: 'utf8' # Optional, default value is 'utf8mb4'. The '--character-set-server' option for mysqld
        collation server: 'utf8_general_ci' # Optional, default value is 'utf8mb4_general_ci'. The '--collation-server' option for mysqld
        mariadb version: '10.4.10' # Optional, default value is "latest". The version of the MariaDB
        mysql database: 'amuse-test' # Optional, default value is "test". The specified database which will be create
        mysql root password: '12345678' # Required if "mysql user" is empty, default is empty. The root superuser password
        mysql user: 'amuse' # Required if "mysql root password" is empty, default is empty. The superuser for the specified database. Can use secrets, too
        mysql password: '12345678' # Required if "mysql user" exists. The password for the "mysql user"
    - name: Verify MariaDB connection from container 
      run: |
        mysql --host 127.0.0.1 -uroot -p12345678 -e "SHOW DATABASES;"
        mysql --host 127.0.0.1 -uroot -p12345678 -e "CREATE SCHEMA amuse-test"
        mysql --host 127.0.0.1 -uroot -p12345678 -e "GRANT ALL PRIVILEGES ON amuse-test.* TO 'amuse'@'%'""
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -B package --file pom.xml
